<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ–π–Ω–∏–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä ‚Äî –ø–æ–≤–Ω–∏–π –∫–æ–º–ø–ª–µ–∫—Ç</title>
<style>
  :root{--bg:#0f172a; --card:#0b1220; --text:#e5e7eb; --muted:#94a3b8; --primary:#3b82f6; --accent:#22c55e; --accent-weak:#16a34a; --danger:#ef4444;}
  html,body{height:100%}
  body{margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial; background:radial-gradient(1200px 600px at 10% -10%, #0b1220, #0f172a); color:var(--text); display:flex; align-items:center; justify-content:center; padding: clamp(12px, 4vw, 24px); box-sizing: border-box;}
  .app{width:min(1000px,100%); background:rgba(11,18,32,.92); border:1px solid rgba(255,255,255,.06); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.5); overflow:hidden; z-index: 10;}
  header{padding:18px 22px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; gap:12px; align-items:center}
  header .logo{width:36px;height:36px;border-radius:10px;display:grid;place-items:center; background: radial-gradient(100% 100% at 10% 0%, var(--primary), #06b6d4); font-weight:700}
  header h1{margin:0; font-size:18px}
  header p{margin:0; color:var(--muted); font-size:13px}
  main{padding:22px}
  .card{background: rgba(2,6,23,.6); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:18px}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .muted{color:var(--muted)}
  .case{white-space:pre-wrap; line-height:1.5; color:#dbeafe; background:rgba(59,130,246,.08); border:1px solid rgba(59,130,246,.2); padding:12px; border-radius:12px;}
  .question{font-size:18px; margin:14px 0 10px; font-weight:700}
  .answers{display:grid; gap:10px; margin:12px 0;}
  .btn{appearance:none; border:none; cursor:pointer; padding:10px 12px; border-radius:12px; background:#0b1324; color:var(--text); border:1px solid rgba(255,255,255,.08); text-align:left; transition:.15s ease}
  .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.2)}
  .btn.primary{background: linear-gradient(180deg, var(--primary), #2563eb); text-align:center; font-weight:700}
  .btn:disabled{opacity: .6; cursor: not-allowed;}
  .btn.block{width:100%}
  .btn.correct{background:linear-gradient(180deg, var(--accent), var(--accent-weak)); border-color:transparent; color:#04120a}
  .btn.wrong{background:linear-gradient(180deg, var(--danger), #b91c1c); border-color:transparent; color:#140404}
  .chip{font-size:12px; color:var(--muted); background:rgba(148,163,184,.12); border:1px solid rgba(148,163,184,.25); padding:6px 10px; border-radius:999px}
  .progress{height:8px; width:100%; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden}
  .progress > div{height:100%; width:0; background:linear-gradient(90deg, #38bdf8, #6366f1); transition: width .25s ease}
  .timebar{height:10px; width:100%; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.08)}
  .timebar > div{height:100%; width:100%; background:linear-gradient(90deg, #22c55e, #f59e0b, #ef4444); transition: width 1s linear}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width: 760px){ .grid2{grid-template-columns:1fr} }
  input, select{background:#0b1324; color:var(--text); border:1px solid rgba(255,255,255,.12); padding:10px 12px; border-radius:12px}
  /* –û–ù–û–í–õ–ï–ù–û: –î–æ–¥–∞–Ω–æ —Å—Ç–∏–ª—å –¥–ª—è –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –∫—É—Ä—Å–æ—Ä—É */
  input { caret-color: transparent; }
  table{width:100%; border-collapse:collapse; margin-top:10px}
  th, td{border-bottom:1px solid rgba(255,255,255,.06); padding:10px 8px; text-align:left; font-size:14px}
  th{color:#c7d2fe}
  #start-error { color: var(--danger); font-size: 14px; margin-top: 10px; display: none; }
</style>

<style id="ua-flag-wallpaper-text">
body{
  background-color:#0057B7 !important;
  background-image: url('data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222400%22%20height%3D%221600%22%20viewBox%3D%220%200%202400%201600%22%3E%3Crect%20width%3D%222400%22%20height%3D%22800%22%20y%3D%220%22%20fill%3D%22%230057B7%22/%3E%3Crect%20width%3D%222400%22%20height%3D%22800%22%20y%3D%22800%22%20fill%3D%22%23FFD700%22/%3E%3C/svg%3E') !important;
  background-size: cover !important;
  background-attachment: fixed !important;
  background-position: center center !important;
}
.footer-text {
    position: fixed;
    bottom: 20px;
    left: 0;
    width: 100%;
    text-align: center;
    color: white;
    font-weight: bold;
    font-size: clamp(0.6rem, 1.8vw, 1.2rem);
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
    pointer-events: none;
    line-height: 1.4;
    padding: 0 10px;
    box-sizing: border-box;
    z-index: 0;
}
</style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="logo">AC</div>
      <div>
        <h1>–ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ–π–Ω–∏–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä ‚Äî –ø–æ–≤–Ω–∏–π –∫–æ–º–ø–ª–µ–∫—Ç</h1>
        <p class="muted">–ú—É–ª—å—Ç–∏–∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π ‚Ä¢ –¢–∞–π–º–µ—Ä ‚Ä¢ –†–µ–π—Ç–∏–Ω–≥ (Google Sheets)</p>
      </div>
    </header>
    <main>
      <div id="screen"></div>
    </main>
  </div>

  <div class="footer-text">
    —É–ø–æ–≤–Ω–æ–≤–∞–∂–µ–Ω–∏–π –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª –∑ –ø–∏—Ç–∞–Ω—å –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è —Ç–∞ –≤–∏—è–≤–ª–µ–Ω–Ω—è –∫–æ—Ä—É–ø—Ü—ñ—ó<br>
    –ù–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—ó –ø–æ–ª—ñ—Ü—ñ—ó –£–∫—Ä–∞—ó–Ω–∏
  </div>

  <script src="questions.js"></script>

<script>
// ======= –ü–∞—Ä–∞–º–µ—Ç—Ä–∏/—É—Ç–∏–ª—ñ—Ç–∏ =======
const SERVER_URL = "https://script.google.com/macros/s/AKfycbzD-sqCtJeMpI-ZqAp08IhR51_c8U7W2AwJt_Umth3Os0HXrI6BE_y4kQtMtUZ54PoFPA/exec";
const $ = s => document.querySelector(s);
const screen = $("#screen");

function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function getServerUrl(){ return SERVER_URL; }

// –û–ù–û–í–õ–ï–ù–û: –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å–ø–∏—Å–∫—É –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤
function getDepartmentOptions(selectedValue = "", placeholder = "–û–±–µ—Ä—ñ—Ç—å –≤–∞—à –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª") {
    const departments = [
        "–ì–£–ù–ü –≤ –ê–†–ö —Ç–∞ –º. –°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—ñ", "–ì–£–ù–ü –≤ –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –î–æ–Ω–µ—Ü—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –ó–∞–ø–æ—Ä—ñ–∑—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –ö–∏—ó–≤—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –õ—É–≥–∞–Ω—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –û–¥–µ—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –ü–æ–ª—Ç–∞–≤—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –†—ñ–≤–Ω–µ–Ω—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –°—É–º—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –•–∞—Ä–∫—ñ–≤—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –•–µ—Ä—Å–æ–Ω—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –•–º–µ–ª—å–Ω–∏—Ü—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –ß–µ—Ä–∫–∞—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü –≤ –ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü —É –í—ñ–Ω–Ω–∏—Ü—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü —É –í–æ–ª–∏–Ω—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü —É –õ—å–≤—ñ–≤—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ", "–ì–£–ù–ü —É –º. –ö–∏—î–≤—ñ", "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ó –±–µ–∑–ø–µ–∫–∏", "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∫—ñ–±–µ—Ä–ø–æ–ª—ñ—Ü—ñ—ó", "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –ø–∞—Ç—Ä—É–ª—å–Ω–æ—ó –ø–æ–ª—ñ—Ü—ñ—ó", "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –ø–æ–ª—ñ—Ü—ñ—ó –æ—Ö–æ—Ä–æ–Ω–∏", "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç —Å—Ç—Ä–∞—Ç–µ–≥—ñ—á–Ω–∏—Ö —Ä–æ–∑—Å–ª—ñ–¥—É–≤–∞–Ω—å", "–î–ó –ê–∫–∞–¥–µ–º—ñ—è –ø–∞—Ç—Ä—É–ª—å–Ω–æ—ó –ø–æ–ª—ñ—Ü—ñ—ó –ù–ü–£", "–î–ó –ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –∞–∫–∞–¥–µ–º—ñ—è –ø–æ–ª—ñ—Ü—ñ—ó", "–î–ó –ö—Ä–∏–≤–æ—Ä—ñ–∑—å–∫–∞ –∞–∫–∞–¥–µ–º—ñ—è –ø–∞—Ç—Ä—É–ª—å–Ω–æ—ó –ø–æ–ª—ñ—Ü—ñ—ó", "–î–ó –†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –∞–∫–∞–¥–µ–º—ñ—è –ø–∞—Ç—Ä—É–ª—å–Ω–æ—ó –ø–æ–ª—ñ—Ü—ñ—ó", "–î–ü–û–ü '–û–®–ë' –õ—é—Ç—å", "–î–£ –í–æ–ª–∏–Ω—Å—å–∫–∏–π –Ω–∞–≤—á–∞–ª—å–Ω–∏–π —Ü–µ–Ω—Ç—Ä –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø–æ–ª—ñ—Ü–µ–π—Å—å–∫–∏—Ö", "–î–£ –¶–µ–Ω—Ç—Ä –∞–≤—ñ–∞—Ü—ñ–π–Ω–æ–≥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –ù–ü–£", "–î–£ –¶–û–ü –ù–ü–£", "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π –æ—Ä–≥–∞–Ω —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–æ–ª—ñ—Ü—ñ—ó"
    ];
    let optionsHtml = `<option value="" disabled ${!selectedValue ? "selected" : ""}>${placeholder}</option>`;
    departments.forEach(dept => {
        optionsHtml += `<option value="${dept}" ${selectedValue === dept ? "selected" : ""}>${dept}</option>`;
    });
    return optionsHtml;
}

async function postResult(payload){
  const url = getServerUrl();
  if (!url) return {ok:false, disabled:true};
  try{
    const res = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body: JSON.stringify(payload)
    });
    return await res.json();
  }catch(e){ return {ok:false, error:String(e)}}
}

async function getLeaderboard(session){
  const url = getServerUrl();
  if (!url) return {ok:false, disabled:true, rows:[]};
  try{
    const res = await fetch(url + "?action=getLeaderboard&session=" + encodeURIComponent(session||'default'));
    return await res.json();
  }catch(e){ return {ok:false, error:String(e), rows:[]};}
}

// ======= –°—Ç–∞–Ω =======
let order = [], idx = 0, answersOrder = [], score = 0, timePerQuestion = 30, remaining = 0, timerId = null, playerName = "", sessionCode = "", isFinished = false;

// –û–ù–û–í–õ–ï–ù–û: –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –ø–æ–ª—ñ–≤ –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤–æ–º—É –µ–∫—Ä–∞–Ω—ñ
function validateStartForm() {
    const nameInput = $('#name');
    const sessSelect = $('#sess');
    const startButton = $('#startBtn');

    if (!nameInput || !sessSelect || !startButton) return;

    const isNameValid = nameInput.value.trim() !== '';
    const isSessValid = sessSelect.value !== '';

    startButton.disabled = !(isNameValid && isSessValid);
}

function startScreen(){
  screen.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 style="margin:0 0 8px 0">–ü–æ—á–Ω—ñ–º–æ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</h2>
          <div class="muted">–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è —Ç–∞ –æ–±–µ—Ä—ñ—Ç—å –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª, —â–æ–± –ø–æ—á–∞—Ç–∏.</div>
        </div>
        <div class="row">
          <button class="btn" onclick="leaderboardScreen()">üèÜ –†–µ–π—Ç–∏–Ω–≥</button>
        </div>
      </div>
      <div class="grid2" style="margin:12px 0">
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <input id="name" placeholder="–Ü–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ" />
          <select id="sess" style="width: 100%;">
            ${getDepartmentOptions(sessionCode, "–û–±–µ—Ä—ñ—Ç—å –≤–∞—à –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª")}
          </select>
        </div>
        <div class="row">
          <label>‚è±Ô∏è –õ—ñ–º—ñ—Ç –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è:&nbsp;
            <select id="timeSel">
              <option value="10">10 —Å</option>
              <option value="20">20 —Å</option>
              <option value="30" selected>30 —Å</option>
              <option value="45">45 —Å</option>
              <option value="60">60 —Å</option>
            </select>
          </label>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <button class="btn primary" id="startBtn" onclick="startQuiz()" disabled>‚ñ∂ –ü–æ—á–∞—Ç–∏</button>
      </div>
      <div id="start-error"></div>
      <div class="card" style="margin-top:12px">
        <div class="muted">–ë–µ–∫–µ–Ω–¥ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ.</div>
      </div>
    </div>
  `;
  // –û–ù–û–í–õ–ï–ù–û: –î–æ–¥–∞—î–º–æ —Å–ª—É—Ö–∞—á—ñ–≤ –ø–æ–¥—ñ–π –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —Ñ–æ—Ä–º–∏
  $('#name').addEventListener('input', validateStartForm);
  $('#sess').addEventListener('change', validateStartForm);
}

function leaderboardScreen(){
  screen.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items: center;">
        <div style="flex-grow: 1;">
          <select id="sessBoard" style="width: 100%;" onchange="refreshBoard()">
            ${getDepartmentOptions(sessionCode, "–û–±–µ—Ä—ñ—Ç—å –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É")}
          </select>
        </div>
        <div class="row">
          <button class="btn" onclick="startScreen()">‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É</button>
        </div>
      </div>
      <div id="board" style="margin-top:8px; min-height: 100px;"></div>
    </div>
  `;
  refreshBoard();
}

async function refreshBoard(){
  const board = $('#board');
  const sessEl = $('#sessBoard');
  const sess = sessEl ? sessEl.value : sessionCode || '';
  
  if (!sess) {
      board.innerHTML = `<div class="muted">–û–±–µ—Ä—ñ—Ç—å –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Ä–µ–π—Ç–∏–Ω–≥—É.</div>`;
      return;
  }
  
  board.innerHTML = `<div class="muted">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>`;

  const res = await getLeaderboard(sess);
  
  if (!res.ok){
    board.innerHTML = `<div class="muted">–ù–µ–º–∞—î –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–µ–∫–µ–Ω–¥—É –∞–±–æ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞.</div>`;
    return;
  }
  const rows = res.rows || [];
  if (rows.length === 0) {
      board.innerHTML = `<div class="muted">–î–ª—è —Ü—å–æ–≥–æ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É —â–µ –Ω–µ–º–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤.</div>`;
      return;
  }

  let html = `<table>
    <thead><tr><th>#</th><th>–Ü–º'—è</th><th>–ë–∞–ª</th><th>–ó –ø–∏—Ç–∞–Ω—å</th><th>%</th><th>‚è±</th><th>–ß–∞—Å</th></tr></thead><tbody>`;
  rows.forEach((r,i)=>{
    html += `<tr>
      <td>${i+1}</td><td>${r.name||''}</td><td>${r.score}</td><td>${r.total}</td>
      <td>${Math.round(r.percent)}%</td><td>${r.timePerQuestion}s</td>
      <td>${(r.timestamp||'').toString().replace('T',' ').replace('Z','')}</td>
    </tr>`;
  });
  html += `</tbody></table>`;
  board.innerHTML = html;
}

async function startQuiz(){
  playerName = ($('#name')?.value || '').trim();
  sessionCode = ($('#sess')?.value || '');
  const errorDiv = $('#start-error');
  const startButton = $('#startBtn');
  errorDiv.style.display = 'none';

  if (!playerName) {
    errorDiv.textContent = "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —ñ–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ.";
    errorDiv.style.display = 'block';
    return;
  }
  if (!sessionCode) {
    errorDiv.textContent = "–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –≤–∞—à –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª.";
    errorDiv.style.display = 'block';
    return;
  }

  startButton.disabled = true;
  startButton.textContent = '–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...';

  let userIp = 'unknown';
  try {
    const ipResponse = await fetch('https://api.ipify.org?format=json');
    const ipData = await ipResponse.json();
    userIp = ipData.ip;
  } catch (error) {
    console.error('Could not fetch IP address:', error);
    errorDiv.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ IP. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.';
    errorDiv.style.display = 'block';
    startButton.disabled = false;
    startButton.textContent = '‚ñ∂ –ü–æ—á–∞—Ç–∏';
    return;
  }

  const checkUrl = `${getServerUrl()}?action=check&session=${encodeURIComponent(sessionCode)}&ip=${encodeURIComponent(userIp)}`;
  
  try {
    const response = await fetch(checkUrl);
    const result = await response.json();

    if (result.ok) {
      if (result.ipTaken) {
        errorDiv.textContent = `–¢–µ—Å—Ç –≤–∂–µ –±—É–ª–æ –ø—Ä–æ–π–¥–µ–Ω–æ –∑ –≤–∞—à–æ—ó IP-–∞–¥—Ä–µ—Å–∏ –¥–ª—è —Ü—å–æ–≥–æ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É.`;
        errorDiv.style.display = 'block';
        startButton.disabled = false;
        startButton.textContent = '‚ñ∂ –ü–æ—á–∞—Ç–∏';
        return;
      }
    } else {
        throw new Error(result.error || 'Unknown server error');
    }
  } catch (error) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏:", error);
    errorDiv.textContent = '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.';
    errorDiv.style.display = 'block';
    startButton.disabled = false;
    startButton.textContent = '‚ñ∂ –ü–æ—á–∞—Ç–∏';
    return;
  }
  
  const sel = $("#timeSel");
  if (sel) timePerQuestion = parseInt(sel.value, 10) || 30;

  order = shuffle([...Array(DATA.length).keys()]);
  idx = 0;
  score = 0;
  answersOrder = order.map(() => shuffle([0,1,2,3]));
  isFinished = false;
  renderQuestion();
}

function setupTimer(){
  clearTimer();
  remaining = timePerQuestion;
  updateTimerUI();
  timerId = setInterval(()=>{
    remaining--;
    if (remaining <= 0){ clearTimer(); timeUp(); }
    else updateTimerUI();
  }, 1000);
}

function clearTimer(){ if (timerId){ clearInterval(timerId); timerId = null; } }

function updateTimerUI(){
  const chip = $("#timeChip");
  const bar = $("#timeBar");
  if (chip) chip.textContent = `‚è≥ –ó–∞–ª–∏—à–∏–ª–æ—Å—å: ${remaining} —Å`;
  if (bar){ const pct = Math.max(0, Math.min(100, Math.round((remaining/timePerQuestion)*100))); bar.style.width = pct + "%"; }
}

function renderQuestion(){
  const i = order[idx];
  const item = DATA[i];
  const map = answersOrder[idx];
  const answers = map.map(m => item.a[m]);
  const progressPct = Math.round((idx)/DATA.length*100);
  screen.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <div class="chip">–ó–∞–≤–¥–∞–Ω–Ω—è ${idx+1} / ${DATA.length}</div>
          <div class="chip">–ë–∞–ª—ñ–≤: ${score}</div>
          <div class="chip" id="timeChip">‚è≥ –ó–∞–ª–∏—à–∏–ª–æ—Å—å: -- —Å</div>
        </div>
        <div class="row">
          <button class="btn" onclick="leaderboardScreen()">üèÜ –†–µ–π—Ç–∏–Ω–≥</button>
          <button class="btn" onclick="startScreen()">‚Ü∫ –°–∫–∏–Ω—É—Ç–∏</button>
        </div>
      </div>
      <div class="progress" style="margin:10px 0 8px;"><div style="width:${progressPct}%"></div></div>
      <div class="timebar" style="margin:6px 0 16px;"><div id="timeBar"></div></div>
      <div class="case">${item.case}</div>
      <div class="question">${item.q}</div>
      <div class="answers">
        ${answers.map((t, k)=>`<button class="btn" id="ans_${k}" onclick="selectAnswer(${k})">${k+1}) ${t}</button>`).join("")}
      </div>
      <div id="feedback" style="display:none; gap:12px; margin-top:8px"></div>
      <div class="row" style="justify-content:space-between; margin-top:8px">
        <div class="muted">–û–±–∏—Ä–∞–π—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —á–∞—Å—É</div>
        <div class="row">
          <button class="btn" onclick="prev()" title="–ù–∞–∑–∞–¥">‚Üê –ù–∞–∑–∞–¥</button>
          <button class="btn primary" onclick="skip()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏</button>
          <button class="btn" onclick="next()">–î–∞–ª—ñ ‚Üí</button>
        </div>
      </div>
    </div>
  `;
  setupTimer();
}

function disableButtonsAndReveal(correctShownIndex, clickedIndex){
  for(let b=0;b<4;b++){
    const el = document.getElementById(`ans_${b}`);
    if (!el) continue;
    el.disabled = true;
    if (b === correctShownIndex) el.classList.add("correct");
    if (clickedIndex !== null && b === clickedIndex && clickedIndex !== correctShownIndex) el.classList.add("wrong");
  }
}

function showFeedback(msg){
  const fb = $("#feedback");
  if (!fb) return;
  fb.style.display = "block";
  fb.innerHTML = `<div class="case" style="background:rgba(34,197,94,.08); border-color:rgba(34,197,94,.25); color:#d1fae5">${msg}</div>`;
}

function selectAnswer(k){
  clearTimer();
  const i = order[idx];
  const item = DATA[i];
  const map = answersOrder[idx];
  const correctShownIndex = map.indexOf(item.correct);
  const isCorrect = (k === correctShownIndex);
  disableButtonsAndReveal(correctShownIndex, k);
  if (isCorrect) score++;
  showFeedback((isCorrect ? "‚úî –ü—Ä–∞–≤–∏–ª—å–Ω–æ!" : "‚úò –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.") + " " + item.explain);
}

function timeUp(){
  const i = order[idx];
  const item = DATA[i];
  const map = answersOrder[idx];
  const correctShownIndex = map.indexOf(item.correct);
  disableButtonsAndReveal(correctShownIndex, null);
  showFeedback("‚è∞ –ß–∞—Å –≤–∏–π—à–æ–≤. " + item.explain);
}

function skip(){ clearTimer(); timeUp(); }
function prev(){ if (idx<=0) return; clearTimer(); idx--; renderQuestion(); }
function next(){ clearTimer(); idx++; if (idx >= DATA.length) return finish(); renderQuestion(); }

async function finish(){
  if (isFinished) return;
  isFinished = true;
  screen.innerHTML = `<div class="card"><h2 style="margin-top:0">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è</h2><p class="muted">–ù–∞–¥—Å–∏–ª–∞—î–º–æ –≤–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç...</p></div>`;
  
  let userIp = 'unknown';
  try {
    const ipResponse = await fetch('https://api.ipify.org?format=json');
    const ipData = await ipResponse.json();
    userIp = ipData.ip;
  } catch (error) {
    console.error('Could not fetch IP address:', error);
  }

  const pct = Math.round((score/DATA.length)*100);
  const payload = { 
    session: sessionCode, name: playerName, score, total: DATA.length, percent: pct, 
    timePerQuestion, ip: userIp, userAgent: navigator.userAgent
  };
  const res = await postResult(payload);

  screen.innerHTML = `
    <div class="card">
      <h2 style="margin-top:0">–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
      <p class="muted">–í–∏ –Ω–∞–±—Ä–∞–ª–∏ <strong>${score}</strong> –∑ ${DATA.length} (${pct}%).</p>
      <div class="row" style="justify-content:space-between; margin-top:10px">
        <div class="row">
          <button class="btn primary" onclick="startQuiz()">–ü—Ä–æ–π—Ç–∏ —â–µ —Ä–∞–∑</button>
          <button class="btn" onclick="startScreen()">–ù–∞ –≥–æ–ª–æ–≤–Ω—É</button>
        </div>
        <div class="row">
          <button class="btn" onclick="leaderboardScreen()">üèÜ –ü–æ–∫–∞–∑–∞—Ç–∏ —Ä–µ–π—Ç–∏–Ω–≥</button>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        ${res?.ok ? "–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ –¥–æ Google Sheets." : "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –º–µ—Ä–µ–∂—ñ."}
      </div>
    </div>
  `;
}

// init
startScreen();
</script>
</body>
</html>